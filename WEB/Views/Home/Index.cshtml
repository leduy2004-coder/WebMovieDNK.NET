@model WEB.Models.HomeViewModel
@{
    ViewData["Title"] = "Home Page";
}
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@{
    var userName = Context.Session.GetString("UserName");
}
<!-- Hiển thị thông báo lỗi nếu có -->
@if (TempData["SuccessMessage"] != null) 
{ 
     <div class="alert alert-danger text-center"> 
         @TempData["SuccessMessage"] 
     </div> 
} 

<section class="slider">
    <img src="./img/banner.png" alt="" class="slider-img">
</section>

<section class="search-section">
    <div class="container">
        <div class="searchs row">
            <div class="col-md-4 col-sm-3 col-xs-12">
                <select id="select-phim">
                    <option>Chọn phim</option>
                    @foreach (var phim in Model.PhimDangChieu)
                    {
                        <option value="@phim.MaPhim">@phim.TenPhim</option>
                    }
                </select>
            </div>

            <div class="col-md-4 col-sm-3 col-xs-12">
                <select id="select-ngay" disabled>
                    <option>Chọn ngày</option>

                    <!-- Các ngày sẽ được thêm vào sau khi chọn phim -->
                </select>
            </div>

            <div class="col-md-4 col-sm-3 col-xs-12">
                <select id="select-suatchieu" disabled>
                    <option>Chọn ca</option>
                    <!-- Các suất chiếu sẽ được thêm vào sau khi chọn ngày -->
                </select>
            </div>
        </div>
    </div>
</section>

<section class="movie-section">
    <div class="container">
        <ul class="nav">
            <li>
                <a data-toggle="tab" class="nav-link active" href="#current">Phim Đang chiếu</a>
            </li>
            <li>
                <a data-toggle="tab" class="nav-link" href="#coming">Phim Sắp chiếu</a>
            </li>
        </ul>

        <div class="tab-pane">
            <div class="movie-list row current active">

                @foreach (var phim in Model.PhimDangChieu)
                {
                    <div class="movie-item col-xl-3 col-lg-3 col-md-4 col-sm-6">
                        <div class="movie-box">
                            @if (@userName != null)
                            {
                            <a href="@Url.Action("Index", "Movie", new { maPhim = phim.MaPhim })" class="movie-link">
                                <img src="@phim.HinhDaiDien" class="card-img-top" />
                            </a>
                            }
                            else
                            {
                                <a href="@Url.Action("loginView", "login")" class="movie-link">
                                    <img src="@phim.HinhDaiDien" class="card-img-top" />
                                </a>
                            }
                        </div>
                        <div class="movie-content">
                            <h4 class="card-header movie-name">@phim.TenPhim</h4>
                            <p class="card-body movie-start">Khởi chiếu: @phim.NgayKhoiChieu.ToString("dd/MM/yyyy")</p>
                        </div>
                    </div>
                }

            </div>

            <div class="movie-list row coming">

                @foreach (var phim in Model.PhimSapChieu)
                {
                    <div class="movie-item col-xl-3 col-lg-3 col-md-4 col-sm-6">
                        <div class="movie-box">
                            @if (@userName != null)
                            {
                                <a href="@Url.Action("Index", "Movie", new { maPhim = phim.MaPhim })" class="movie-link">
                                    <img src="@phim.HinhDaiDien" class="card-img-top" />
                                </a>
                            }
                            else
                            {
                                <a href="@Url.Action("loginView", "login")" class="movie-link">
                                    <img src="@phim.HinhDaiDien" class="card-img-top" />
                                </a>
                            }
                        </div>
                        <div class="movie-content">
                            <h4 class="card-header movie-name">@phim.TenPhim</h4>
                            <p class="card-body movie-start">Khởi chiếu: @phim.NgayKhoiChieu.ToString("dd/MM/yyyy")</p>
                        </div>
                    </div>
                }

            </div>
        </div>
    </div>
</section>

<section class="pricing-section">
    <div class="container my-5">
        <h2 style="text-align:center">
            <a href="/uu-dai.html"
               style="color:#fff;text-transform:uppercase;text-decoration:none">Ưu Đãi</a>
        </h2>
        <div class="row">
            <div class="owl-carousel owl-theme">
                <div class="item">
                    <div class="card">
                        <img src="./img/pricing-1.jpg" alt="img" class="card-img-top-bottom">
                        <div class="card-content">
                            <h4><a href="#">TUNG TĂNG TUỔI 22 - ĐỒNG GIÁ VÉ 45K</a></h4>
                            <div class="text">
                                💥 Các bạn T22 của RIO ơi! Thời tới rồi! Tin siêu hot cho các bạn đây:
                                Từ 20/09/2023, RIO đặc quyền thêm ưu đãi đối với lứa tuổi chúng mình ĐỒNG GIÁ 4 ...
                            </div>
                            <button class="btn">
                                <a href="#">Xem thêm </a>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="item">
                    <div class="card">
                        <img src="./img/pricing-2.jpg" alt="img" class="card-img-top-bottom">
                        <div class="card-content">
                            <h4><a href="#">TUNG TĂNG TUỔI 22 - ĐỒNG GIÁ VÉ 45K</a></h4>
                            <div class="text">
                                💥 Các bạn T22 của RIO ơi! Thời tới rồi! Tin siêu hot cho các bạn đây:
                                Từ 20/09/2023, RIO đặc quyền thêm ưu đãi đối với lứa tuổi chúng mình ĐỒNG GIÁ 4 ...
                            </div>
                            <button class="btn">
                                <a href="#">Xem thêm </a>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="item">
                    <div class="card">
                        <img src="./img/pricing-3.jpg" alt="img" class="card-img-top-bottom">
                        <div class="card-content">
                            <h4><a href="#">TUNG TĂNG TUỔI 22 - ĐỒNG GIÁ VÉ 45K</a></h4>
                            <div class="text">
                                💥 Các bạn T22 của RIO ơi! Thời tới rồi! Tin siêu hot cho các bạn đây:
                                Từ 20/09/2023, RIO đặc quyền thêm ưu đãi đối với lứa tuổi chúng mình ĐỒNG GIÁ 4 ...
                            </div>
                            <button class="btn">
                                <a href="#">Xem thêm </a>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="item">
                    <div class="card">
                        <img src="./img/pricing-2.jpg" alt="img" class="card-img-top-bottom">
                        <div class="card-content">
                            <h4><a href="#">TUNG TĂNG TUỔI 22 - ĐỒNG GIÁ VÉ 45K</a></h4>
                            <div class="text">
                                💥 Các bạn T22 của RIO ơi! Thời tới rồi! Tin siêu hot cho các bạn đây:
                                Từ 20/09/2023, RIO đặc quyền thêm ưu đãi đối với lứa tuổi chúng mình ĐỒNG GIÁ 4 ...
                            </div>
                            <button class="btn">
                                <a href="#">Xem thêm </a>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="item">
                    <div class="card">
                        <img src="./img/pricing-3.jpg" alt="img" class="card-img-top-bottom">
                        <div class="card-content">
                            <h4><a href="#">TUNG TĂNG TUỔI 22 - ĐỒNG GIÁ VÉ 45K</a></h4>
                            <div class="text">
                                💥 Các bạn T22 của RIO ơi! Thời tới rồi! Tin siêu hot cho các bạn đây:
                                Từ 20/09/2023, RIO đặc quyền thêm ưu đãi đối với lứa tuổi chúng mình ĐỒNG GIÁ 4 ...
                            </div>
                            <button class="btn">
                                <a href="#">Xem thêm </a>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <form id="bookTicketForm" action="/BookTicket/GetBookTicket" method="get">
        <input type="hidden" id="maSuat" name="maSuat">
    </form>


</section>

<script>
    $('.owl-carousel').owlCarousel({
        loop: true,
        margin: 15,
        nav: true,
        dots: false,
        responsive: {
            0: {
                items: 1
            },
            768: {
                items: 2
            },
            1000: {
                items: 3
            }
        }
    });


    const tabs = document.querySelectorAll('.movie-section .nav .nav-link');
    const tabPane = document.querySelectorAll('.tab-pane .movie-list');
    console.log(tabPane);

    tabs.forEach((tab, index) => {
        tab.addEventListener('click', function () {
            if (!tab.classList.contains('active')) {
                tabs.forEach(item => {
                    item.classList.remove('active');
                });
                tab.classList.add('active');

                tabPane.forEach(item => {
                    item.classList.remove('active');
                });

                tabPane[index].classList.add('active');
            }
        });
    });

    // Khi chọn phim, cập nhật ngày xem
    document.getElementById("select-phim").addEventListener("change", function() {
        const phimId = this.value;

        // Nếu không chọn phim thì không làm gì
        if (!phimId) {
            return;
        }

        // Gửi yêu cầu Ajax để lấy ngày chiếu cho phim đã chọn
        fetch('https://localhost:7079/api/Phim/ngayxem/' + phimId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Xóa hết các option cũ
                const ngaySelect = document.getElementById("select-ngay");
                ngaySelect.innerHTML = '<option>Chọn ngày xem</option>';

                // Thêm các option ngày xem mới
                data.forEach(ngay => {
                    const option = document.createElement("option");
                    option.textContent = ngay;
                    ngaySelect.appendChild(option);
                });

                // Kích hoạt select ngày
                ngaySelect.disabled = false;
            })
            .catch(error => {
                console.error('Có lỗi xảy ra khi lấy dữ liệu:', error);
            });

    });

    // Khi chọn ngày, cập nhật suất chiếu
        document.getElementById("select-ngay").addEventListener("change", function() {
        const phimId = document.getElementById("select-phim").value;
        let ngay = this.value;

        // Nếu không chọn ngày thì không làm gì
        if (!ngay) {
            return;
        }

        // Thay đổi dấu / thành dấu - nếu ngày có dấu /
        ngay = ngay.replace(/\//g, '-');  // Đổi tất cả dấu / thành -

        // Gửi yêu cầu Ajax để lấy suất chiếu cho phim và ngày đã chọn
        fetch(`https://localhost:7079/api/suatchieu/${phimId}/${ngay}`)
            .then(response => response.json())
            .then(data => {
                // Xóa hết các option cũ
                const suatChieuSelect = document.getElementById("select-suatchieu");
                suatChieuSelect.innerHTML = '<option>Chọn suất chiếu</option>';

                // Thêm các option suất chiếu mới
                data.forEach(suatchieu => {
                    const option = document.createElement("option");
                    option.value = suatchieu.maSuat;
                    option.textContent = suatchieu.thoiGianBatDau;
                    suatChieuSelect.appendChild(option);
                });

                // Kích hoạt select suất chiếu
                suatChieuSelect.disabled = false;
            })
            .catch(error => {
                console.error("Lỗi khi lấy dữ liệu:", error);
            });
    });

    // Khi chọn ngày, suất chiếu và ca
        document.getElementById("select-suatchieu").addEventListener("change", function() {
        var selectedValue = this.value;

        if (!selectedValue) {
            return;
        }

        // Gán giá trị đã chọn vào input ẩn trong form
        document.getElementById("maSuat").value = selectedValue;

        // Submit form để gửi dữ liệu
        document.getElementById("bookTicketForm").submit();
    });



</script>
